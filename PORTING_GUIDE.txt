Enhanced BASIC Porting Guide for MVME167
========================================

OVERVIEW
--------
You're porting Lee Davison's Enhanced 68k BASIC to run on your MVME167-02.
The good news: BASIC is already 68k assembly, so no compilation needed.
The work: Replace the I/O routines with MVME167-specific CD2401 code.

KEY RESOURCES
-------------
1. serial167.c (Linux driver)
   - Complete CD2401 register usage for MVME167
   - Already handles the quirks of this specific board
   - Reference for putchar/getchar implementation

2. Jeff Tranter's Enhanced BASIC port
   - github.com/jefftranter/68000/tree/master/ehbasic
   - TS2 board port (similar platform to yours)
   - Shows how console I/O is integrated

3. Your uploaded serial167.c
   - Has the PCC2 register info (lines 104-110)
   - Shows how Linux handles channel 0 console I/O

PORTING STEPS
-------------

STEP 1: Get the Enhanced BASIC source
   Clone: git clone https://github.com/jefftranter/68000.git
   This gives you the base assembly code to work from.

STEP 2: Understand the structure
   The BASIC source will have:
   - Main interpreter loop
   - Character I/O routines (likely simple stubs or placeholder calls)
   - Memory layout definitions
   - Reset/initialization code

STEP 3: Adapt the I/O routines
   Look for where Enhanced BASIC calls character I/O.
   Replace with GETCHAR/PUTCHAR that use CD2401 registers.
   
   Your serial167.c shows exactly how to do this:
   - Lines 2569-2627: serial167_console_write() = PUTCHAR
   - Lines 2706-2774: getDebugChar() = GETCHAR
   
   The polling versions in our cd2401_io_68k.s are simplified from these.

STEP 4: Define MVME167-specific values
   You need:
   - CD2401_BASE = $FFF45000
   - Console port = 0
   - Baud rate tables (from serial167.c lines 162-173)
   
   These are provided in cd2401_registers.h

STEP 5: Decide on initialization approach
   Option A: Assume 167Bug has already initialized CD2401
      - Simplest approach
      - Just enable channel 0 for I/O
      - Saves code space
      - Works great for a ROM running under monitor
   
   Option B: Full CD2401 initialization
      - More complex
      - Needed if running standalone without monitor
      - See debug_setup() in serial167.c (lines 2788-2854)

   RECOMMENDATION: Use Option A for now (ROM running under 167Bug)

STEP 6: Memory layout setup
   For RAM execution (during development):
   - Origin: $00400000 (or wherever you set your RAM base)
   - Stack: High memory
   - Program: Low memory
   - This is handled by your assembler
   
   For ROM execution (final version):
   - Origin: $FF800000 (MVME167 ROM space)
   - Assemble same code, just change origin
   - Program memory becomes ROM

STEP 7: Assemble for testing
   With your m68k toolchain:
   - Assemble enhanced_basic.s to enhanced_basic.o
   - Link to enhanced_basic.elf
   - Convert to S-records: objcopy -O srec enhanced_basic.elf enhanced_basic.srec
   
   Load via Motorola monitor:
   > LOAD
   [send S-record file]
   > GO 400000
   [BASIC starts]

BUILD ENVIRONMENT SETUP
-----------------------

You need:
1. Cross-assembler: m68k-elf-as (or m68k-linux-as)
   Install: apt-get install binutils-m68k-linux-gnu
   
2. Cross-linker: m68k-elf-ld
   Comes with binutils
   
3. Object tools: m68k-elf-objcopy
   Also in binutils
   
4. Build tool: make
   Standard on any Linux system

Sample Makefile:
```makefile
CROSS = m68k-elf-
AS = $(CROSS)as
LD = $(CROSS)ld
OBJCOPY = $(CROSS)objcopy
ASFLAGS = -m68040

# For RAM testing
RAM_BASE = 0x00400000

# For ROM final
ROM_BASE = 0xff800000

# Default target
all: ehbasic.srec

ehbasic.elf: ehbasic.o
	$(LD) --oformat elf32-m68k -Ttext $(RAM_BASE) -o $@ $^

ehbasic.o: ehbasic.s cd2401_io_68k.s
	$(AS) $(ASFLAGS) -o $@ ehbasic.s

ehbasic.srec: ehbasic.elf
	$(OBJCOPY) -O srec $< $@

rom: ehbasic_rom.elf
ehbasic_rom.elf: ehbasic.o
	$(LD) --oformat elf32-m68k -Ttext $(ROM_BASE) -o $@ $^

clean:
	rm -f *.o *.elf *.srec
```

INTEGRATION CHECKLIST
---------------------
- [ ] Get Jeff Tranter's Enhanced BASIC source
- [ ] Identify the I/O routine section
- [ ] Replace with MVME167 CD2401 version from cd2401_io_68k.s
- [ ] Update memory layout for $00400000 (RAM test) origin
- [ ] Test assemble with m68k-elf-as
- [ ] Link and convert to S-records
- [ ] Load via Motorola monitor
- [ ] Test character I/O (should prompt "Ready")
- [ ] Run a simple BASIC program
- [ ] Once working in RAM, reassemble for ROM ($FF800000)
- [ ] Program EPROM chips
- [ ] Test from ROM boot

SERIAL167.C REFERENCE POINTS
-----------------------------
For more complex features, refer to:

Transmit (line 2569-2627):
  - How to wait for TX interrupt
  - How to write to CyTDR
  - How PCC2 interrupt routing works

Receive (line 2706-2774):
  - How to check CyRFOC for data available
  - How to read from CyRDR
  - FIFO handling

Channel setup (line 2799-2854):
  - Baud rate configuration
  - COR1-COR7 settings (parity, stop bits, etc.)
  - Initialization sequence

Our simplified version skips most of this because 167Bug already
set it up. We just do character I/O polling.

TESTING STRATEGY
----------------

1. Start with simple putchar/getchar testing
   - Load BASIC ROM in RAM
   - Type a character at console
   - It should echo back
   - Type "READY" (if that's the BASIC prompt)
   - Enter simple math: 2+2
   - See if it computes

2. Test basic BASIC programs
   10 PRINT "HELLO"
   20 END
   RUN
   Should print: HELLO

3. Verify no hangs during I/O
   If BASIC hangs on input/output, check:
   - Are we correctly polling CyRFOC?
   - Is CyCAR being set to channel 0?
   - Are we actually reaching the CD2401 base address?

4. Once stable in RAM, burn to EPROM and test from ROM

TROUBLESHOOTING
---------------

If putchar doesn't work:
  - Check CyCCR is clear before enabling transmitter
  - Check you're writing to correct CyTDR offset
  - Verify CD2401_BASE is accessible ($FFF45000)
  - Try a simple loop: send 'A' repeatedly

If getchar hangs:
  - Check CyRFOC returns non-zero when chars typed
  - Verify CyCAR is set to CONSOLE_PORT (0)
  - Check CyRDR is being read
  - Serial cable/terminal might not be connected

If BASIC starts but hangs on first prompt:
  - Probably stuck in getchar
  - Serial input not working
  - Check terminal settings match monitor (9600 baud typical)

NEXT STEPS
----------

1. Download Enhanced BASIC source from GitHub
2. Install m68k-elf toolchain
3. Set up project directory
4. Create simple test program that:
   - Calls CD2401_INIT
   - Loops: getchar, putchar (echo test)
5. Assemble and load via monitor
6. Test echo functionality
7. Integrate with full Enhanced BASIC
8. Proceed to ROM burning once stable

Questions to consider:
- What baud rate does your terminal expect? (likely 9600)
- Does BASIC need flow control (RTS/CTS)?
- Do you need receive buffering or polling is fine?
- Will you support all 4 serial ports or just port 0?

Good luck! This is a fun project.
